<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n l√Ω h·ªì s∆°</title>
	<style>
		body {
			background: #f7f9fc;
			/* M√†u n·ªÅn nh·∫°t h∆°n */
			font-family: 'Inter', sans-serif;
			/* Font ch·ªØ hi·ªán ƒë·∫°i */
		}
	</style>
	<link rel="stylesheet" href="/css/record-management.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">


	<!-- <link rel="stylesheet" href="/css/message.css"> -->
</head>

<body>
	<main>
		<div id="app" class="container" style="max-width: 1100px; margin: 20px auto;">
		<!-- 1 KH·ªêI CARD DUY NH·∫§T -->
        <div class="big-card">
			<h2 class="title-page">Qu·∫£n l√Ω h·ªì s∆°</h2>
				<!-- Form t√¨m ki·∫øm -->
				<div class="search-row">
					<input id="searchInput" class="search-input" type="text" placeholder="T√¨m theo t√™n, email, SƒêT...">
					<button id="btnSearch" class="btn btn-primary">T√¨m</button>
					<button id="btnRefresh" class="btn btn-secondary">L√†m m·ªõi</button>
				</div>

				<hr class="divider">

				<!-- Form th√™m / s·ª≠a -->
				<h3 id="formTitle">Th√™m h·ªì s∆°</h3>

				<div class="input-group">
					<i class="fa-solid fa-user"></i>
					<input id="name" class="input" placeholder="H·ªç t√™n">
				</div>

				<div class="input-group">
					<i class="fa-solid fa-envelope"></i>
					<input id="email" class="input" placeholder="Email">
				</div>

				<div class="input-group">
					<i class="fa-solid fa-phone"></i>
					<input id="phone" class="input" placeholder="S·ªë ƒëi·ªán tho·∫°i">
				</div>

				<div class="input-group">
					<i class="fa-solid fa-location-dot"></i>
					<input id="address" class="input" placeholder="ƒê·ªãa ch·ªâ">
				</div>

				<div class="input-group textarea-group">
					<i class="fa-solid fa-note-sticky"></i>
					<textarea id="notes" class="input" placeholder="Ghi ch√∫"></textarea>
				</div>

				<div style="display:flex; gap:8px;">
					<button id="btnSubmit" class="btn btn-primary">üíæ L∆∞u</button>
					<button id="btnCancelEdit" class="btn" style="display:none;">H·ªßy</button>
				</div>

				<hr class="divider">

				<!-- B·∫£ng -->
				<table>
					<thead>
						<tr>
							<th>H·ªç t√™n</th>
							<th>Email</th>
							<th>SƒêT</th>
							<th>ƒê·ªãa ch·ªâ</th>
							<th style="width:160px;">Thao t√°c</th>
						</tr>
					</thead>
					<tbody id="recordsTbody"></tbody>
				</table>

				<div class="pagination-wrapper">
					<div class="rows-per-page">
						Hi·ªÉn th·ªã:
						<select id="rowsPerPage">
							<option value="5">5 d√≤ng</option>
							<option value="10" selected>10 d√≤ng</option>
							<option value="20">20 d√≤ng</option>
						</select>
					</div>

					<div id="pagination" class="pagination"></div>
				</div>

				<div id="emptyState" style="display:none; padding: 16px; text-align:center; color:#6b7280;">
					Ch∆∞a c√≥ d·ªØ li·ªáu
				</div>

			</div>
		</div>
	</main>

	<!-- <script type="module" src="/js/utils/message.js"></script> -->
	<script type="module" src="/js/layout.js"></script>
	<script type="module">
		import { showMessage } from '/js/utils/message.js';
		import { fetchApi } from '/js/utils/fetchApi.js';
		import { executeApiCall } from '/js/utils/apiExecutor.js';
		let editingId = null;
		const el = (id) => document.getElementById(id);
		const tbody = el('recordsTbody');
		const emptyState = el('emptyState');

		const getFormData = () => ({
			name: el('name').value.trim(),
			email: el('email').value.trim(),
			phone: el('phone').value.trim(),
			address: el('address').value.trim(),
			notes: el('notes').value.trim()
		});
		const resetForm = () => {
			el('name').value = '';
			el('email').value = '';
			el('phone').value = '';
			el('address').value = '';
			el('notes').value = '';
			editingId = null;
			el('formTitle').innerText = 'Th√™m h·ªì s∆°';
			el('btnCancelEdit').style.display = 'none';
		};

		const renderRows = (items) => {
			tbody.innerHTML = '';
			if (!items || items.length === 0) {
				emptyState.style.display = 'block';
				return;
			}
			emptyState.style.display = 'none';
			items.forEach(p => {
				const tr = document.createElement('tr');
				tr.style.borderBottom = '1px solid #f3f4f6';
				tr.innerHTML = `
						<td style=\"padding: 8px;\">${p.name || ''}</td>
						<td style=\"padding: 8px;\">${p.email || ''}</td>
						<td style=\"padding: 8px;\">${p.phone || ''}</td>
						<td style=\"padding: 8px;\">${p.address || ''}</td>
						<td style=\"display: none;\">${p.notes || ''}</td>
						<td style=\"padding: 8px;\">
							<button data-edit="${p._id}" class="btn-edit">
								<i class="fa-solid fa-pen-to-square"></i> S·ª≠a
							</button>

							<button data-delete="${p._id}" class="btn-delete">
								<i class="fa-solid fa-trash"></i> X√≥a
							</button>
						</td>
					`;
				tbody.appendChild(tr);
			});
		};

		async function loadRecords(query = '') {
			try {
				const q = query ? `?q=${encodeURIComponent(query)}` : '';
<<<<<<< HEAD
				const data = await fetchApi(`/records${q}`, 'GET', null, '', { useSession: true });
=======
				const data = await fetchApi(`/records${q}`, 'GET', null, { useSession: true });
>>>>>>> 52203030bb34a7492dc04b587052c8ca74182db4
				fullData = data.items || [];

				currentPage = 1;
				updateUI();
			} catch (err) {
				showMessage(err.message || 'L·ªói t·∫£i d·ªØ li·ªáu', 'error', 'response');
			}
		}

		async function submitForm() {
            const payload = getFormData();

            // 1. Ki·ªÉm tra ƒë·∫ßu v√†o ph√≠a client (v·∫´n gi·ªØ l·∫°i)
            if (!payload.name || !payload.email) {
                showMessage('Vui l√≤ng nh·∫≠p H·ªç t√™n v√† Email', 'error', 'response');
                return;
            }

            let apiPromise;

            if (editingId) {
                // C·∫≠p nh·∫≠t (PUT)
<<<<<<< HEAD
                apiPromise = fetchApi(`/records/${editingId}`, 'PUT', payload, '', { useSession: true });
            } else {
                // T·∫°o m·ªõi (POST)
                apiPromise = fetchApi('/records', 'POST', payload, '', { useSession: true });
=======
                apiPromise = fetchApi(`/records/${editingId}`, 'PUT', payload, { useSession: true });
            } else {
                // T·∫°o m·ªõi (POST)
                apiPromise = fetchApi('/records', 'POST', payload, { useSession: true });
>>>>>>> 52203030bb34a7492dc04b587052c8ca74182db4
            }

            // 2. S·ª≠ d·ª•ng executeApiCall ƒë·ªÉ x·ª≠ l√Ω to√†n b·ªô logic g·ªçi API v√† hi·ªÉn th·ªã th√¥ng b√°o
            const result = await executeApiCall(
                apiPromise,
                async (data) => {
                    resetForm();
                    await loadRecords(el('searchInput').value.trim());
                }
            );

            // Kh√¥ng c·∫ßn try...catch l·ªõn n·ªØa
            // L·ªói (error) v√† Th·∫•t b·∫°i (data.status != 'success') ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω b√™n trong executeApiCall
        }

		async function deleteItem(id) {
			if (!confirm('X√≥a h·ªì s∆° n√†y?')) return;
			try {
				await fetchApi(`/records/${id}`, 'DELETE', null, { useSession: true });
				showMessage('ƒê√£ x√≥a', 'success', 'response');
				await loadRecords(el('searchInput').value.trim());
			} catch (err) {
				showMessage(err.message || 'X√≥a th·∫•t b·∫°i', 'error', 'response');
			}
		}

		function startEditRow(id) {
			const row = [...tbody.querySelectorAll('button[data-edit]')].find(b => b.getAttribute('data-edit') === id)?.closest('tr');
			if (!row) return;
			const tds = row.querySelectorAll('td');
			el('name').value = tds[0].innerText;
			el('email').value = tds[1].innerText;
			el('phone').value = tds[2].innerText;
			el('address').value = tds[3].innerText;
			el('notes').value = tds[4].innerText;
			editingId = id;
			el('formTitle').innerText = 'S·ª≠a h·ªì s∆°';
			el('btnCancelEdit').style.display = 'inline-block';
		}

		// Events
		el('btnSubmit').addEventListener('click', submitForm);
		el('btnCancelEdit').addEventListener('click', resetForm);
		el('btnSearch').addEventListener('click', () => loadRecords(el('searchInput').value.trim()));
		el('btnRefresh').addEventListener('click', () => {
			el('searchInput').value = '';
			loadRecords();
		});
		document.getElementById('recordsTbody').addEventListener('click', (e) => {
			const editId = e.target.getAttribute('data-edit');
			const delId = e.target.getAttribute('data-delete');
			if (editId) startEditRow(editId);
			if (delId) deleteItem(delId);
		});


		// Pagination state
		let currentPage = 1;
		let rowsPerPage = 10;
		let fullData = []; // d·ªØ li·ªáu g·ªëc
		document.getElementById("rowsPerPage").addEventListener("change", function () {
			rowsPerPage = parseInt(this.value);
			currentPage = 1;
			updateUI();
		});

		// T·∫°o n√∫t trang
		function renderPagination(totalItems) {
			const totalPages = Math.ceil(totalItems / rowsPerPage);
			const paginationDiv = document.getElementById("pagination");
			paginationDiv.innerHTML = "";

			// N√∫t Previous
			const prevBtn = document.createElement("button");
			prevBtn.textContent = "¬´ Prev";
			prevBtn.disabled = currentPage === 1;
			prevBtn.onclick = () => { currentPage--; updateUI(); };
			paginationDiv.appendChild(prevBtn);

			// C√°c s·ªë trang
			for (let i = 1; i <= totalPages; i++) {
				const btn = document.createElement("button");
				btn.textContent = i;
				if (i === currentPage) btn.classList.add("active");
				btn.onclick = () => { currentPage = i; updateUI(); };
				paginationDiv.appendChild(btn);
			}

			// N√∫t Next
			const nextBtn = document.createElement("button");
			nextBtn.textContent = "Next ¬ª";
			nextBtn.disabled = currentPage === totalPages;
			nextBtn.onclick = () => { currentPage++; updateUI(); };
			paginationDiv.appendChild(nextBtn);
		}

		// C·∫≠p nh·∫≠t UI theo trang
		function updateUI() {
			const start = (currentPage - 1) * rowsPerPage;
			const end = start + rowsPerPage;

			renderRows(fullData.slice(start, end));
			renderPagination(fullData.length);
		}

		        const debounce = (func, delay = 500) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(null, args);
                }, delay);
            };
        };

		        // **T·∫°o phi√™n b·∫£n Debounced c·ªßa loadRecords**
        const debouncedLoadRecords = debounce((query) => {
            loadRecords(query);
        }, 400);
        // Events
        el('btnSubmit').addEventListener('click', submitForm);
        el('btnCancelEdit').addEventListener('click', resetForm);
        // el('btnSearch').addEventListener('click', () => loadRecords(el('searchInput').value.trim()));
        el('searchInput').addEventListener('input', (e) => {
            // G·ªçi h√†m t√¨m ki·∫øm ƒë√£ ƒë∆∞·ª£c Debounce
            debouncedLoadRecords(e.target.value.trim());
        });
        el('btnRefresh').addEventListener('click', () => {
            el('searchInput').value = '';
            loadRecords();
        });
        document.getElementById('recordsTbody').addEventListener('click', (e) => {
            const editId = e.target.getAttribute('data-edit');
            const delId = e.target.getAttribute('data-delete');
            if (editId) startEditRow(editId);
            if (delId) deleteItem(delId);
        });


		// Init
		loadRecords();

	</script>
</body>

</html>