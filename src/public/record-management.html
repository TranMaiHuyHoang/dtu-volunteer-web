<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Quản lý hồ sơ</title>
	<!-- <link rel="stylesheet" href="/css/message.css"> -->
</head>

<body>
	<main>
		<div id="app" class="container" style="max-width: 1000px; margin: 20px auto;">
			<h2 style="margin: 10px 0 20px 0;">Quản lý hồ sơ</h2>

			<div id="response" class="message-container"></div>

			<!-- Form tìm kiếm -->
			<div style="display: flex; gap: 10px; margin-bottom: 16px;">
				<input id="searchInput" type="text" placeholder="Tìm theo tên, email, SĐT..."
					style="flex:1; padding: 10px;">
				<button id="btnSearch" class="btn btn-primary">Tìm</button>
				<button id="btnRefresh" class="btn">Làm mới</button>
			</div>

			<!-- Form thêm/sửa -->
			<div style="border:1px solid #e5e7eb; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
				<h3 id="formTitle" style="margin-bottom: 10px;">Thêm hồ sơ</h3>
				<input id="name" placeholder="Họ tên" style="width:100%; padding: 8px; margin-bottom:8px;">
				<input id="email" placeholder="Email" style="width:100%; padding: 8px; margin-bottom:8px;">
				<input id="phone" placeholder="Số điện thoại" style="width:100%; padding: 8px; margin-bottom:8px;">
				<input id="address" placeholder="Địa chỉ" style="width:100%; padding: 8px; margin-bottom:8px;">
				<textarea id="notes" placeholder="Ghi chú"
					style="width:100%; padding: 8px; margin-bottom:8px;"></textarea>
				<div style="display:flex; gap:8px;">
					<button id="btnSubmit" class="btn btn-primary">Lưu</button>
					<button id="btnCancelEdit" class="btn" style="display:none;">Hủy</button>
				</div>
			</div>

			<!-- Bảng danh sách -->
			<table style="width:100%; border-collapse: collapse;">
				<thead>
					<tr style="text-align:left; border-bottom: 1px solid #e5e7eb;">
						<th style="padding: 8px;">Họ tên</th>
						<th style="padding: 8px;">Email</th>
						<th style="padding: 8px;">SĐT</th>
						<th style="padding: 8px;">Địa chỉ</th>
						<th style="padding: 8px; width: 160px;">Thao tác</th>
					</tr>
				</thead>
				<tbody id="recordsTbody"></tbody>
			</table>
			<div id="emptyState" style="display:none; padding: 16px; text-align:center; color:#6b7280;">Chưa có dữ liệu
			</div>
		</div>
	</main>

	<!-- <script type="module" src="/js/utils/message.js"></script> -->
	<script type="module" src="/js/layout.js"></script>
	<script type="module">
		import { showMessage } from '/js/utils/message.js';
		import { fetchApi } from '/js/utils/fetchApi.js';
		import { executeApiCall } from '/js/utils/apiExecutor.js';
		let editingId = null;

		const el = (id) => document.getElementById(id);
		const tbody = el('recordsTbody');
		const emptyState = el('emptyState');

		const getFormData = () => ({
			name: el('name').value.trim(),
			email: el('email').value.trim(),
			phone: el('phone').value.trim(),
			address: el('address').value.trim(),
			notes: el('notes').value.trim()
		});
		const resetForm = () => {
			el('name').value = '';
			el('email').value = '';
			el('phone').value = '';
			el('address').value = '';
			el('notes').value = '';
			editingId = null;
			el('formTitle').innerText = 'Thêm hồ sơ';
			el('btnCancelEdit').style.display = 'none';
		};

		const renderRows = (items) => {
			tbody.innerHTML = '';
			if (!items || items.length === 0) {
				emptyState.style.display = 'block';
				return;
			}
			emptyState.style.display = 'none';
			items.forEach(p => {
				const tr = document.createElement('tr');
				tr.style.borderBottom = '1px solid #f3f4f6';
				tr.innerHTML = `
					<td style=\"padding: 8px;\">${p.name || ''}</td>
					<td style=\"padding: 8px;\">${p.email || ''}</td>
					<td style=\"padding: 8px;\">${p.phone || ''}</td>
					<td style=\"padding: 8px;\">${p.address || ''}</td>
					<td style=\"display: none;\">${p.notes || ''}</td>
					<td style=\"padding: 8px;\">
						<button data-edit=\"${p._id}\" class=\"btn\">Sửa</button>
						<button data-delete=\"${p._id}\" class=\"btn btn-danger\">Xóa</button>
					</td>
				`;
				tbody.appendChild(tr);
			});
		};

		async function loadRecords(query = '') {
			try {
				const q = query ? `?q=${encodeURIComponent(query)}` : '';
				const data = await fetchApi(`/records${q}`, 'GET', null, '', { useSession: true });
				renderRows(data.items);
			} catch (err) {
				showMessage(err.message || 'Lỗi tải dữ liệu', 'error', 'response');
			}
		}

		async function submitForm() {
			const payload = getFormData();

			// 1. Kiểm tra đầu vào phía client (vẫn giữ lại)
			if (!payload.name || !payload.email) {
				showMessage('Vui lòng nhập Họ tên và Email', 'error', 'response');
				return;
			}

			let apiPromise;

			if (editingId) {
				// Cập nhật (PUT)
				apiPromise = fetchApi(`/records/${editingId}`, 'PUT', payload, '', { useSession: true });
			} else {
				// Tạo mới (POST)
				apiPromise = fetchApi('/records', 'POST', payload, '', { useSession: true });
			}

			// 2. Sử dụng executeApiCall để xử lý toàn bộ logic gọi API và hiển thị thông báo
			const result = await executeApiCall(
				apiPromise,
				async (data) => {
							resetForm();
							await loadRecords(el('searchInput').value.trim());
				}
			);

			// Không cần try...catch lớn nữa
			// Lỗi (error) và Thất bại (data.status != 'success') đã được xử lý bên trong executeApiCall
		}
		// async function submitForm() {
		// 	try {
		// 		const payload = getFormData();
		// 		if (!payload.name || !payload.email) {
		// 			showMessage('Vui lòng nhập Họ tên và Email', 'error', 'response');
		// 			return;
		// 		}
		// 		if (editingId) {
		// 			await fetchApi(`/records/${editingId}`, 'PUT', payload, '', { useSession: true });
		// 			showMessage('Cập nhật thành công', 'success', 'response');
		// 		} else {
		// 			await fetchApi('/records', 'POST', payload, '', { useSession: true });
		// 			showMessage('Tạo hồ sơ thành công', 'success', 'response');
		// 		}
		// 		resetForm();
		// 		await loadRecords(el('searchInput').value.trim());
		// 	} catch (err) {
		// 		showMessage(err.message || 'Thao tác thất bại', 'error', 'response');
		// 	}
		// }

		async function deleteItem(id) {
			if (!confirm('Xóa hồ sơ này?')) return;
			try {
				await fetchApi(`/records/${id}`, 'DELETE', null, '', { useSession: true });
				showMessage('Đã xóa', 'success', 'response');
				await loadRecords(el('searchInput').value.trim());
			} catch (err) {
				showMessage(err.message || 'Xóa thất bại', 'error', 'response');
			}
		}

		function startEditRow(id) {
			const row = [...tbody.querySelectorAll('button[data-edit]')].find(b => b.getAttribute('data-edit') === id)?.closest('tr');
			if (!row) return;
			const tds = row.querySelectorAll('td');
			el('name').value = tds[0].innerText;
			el('email').value = tds[1].innerText;
			el('phone').value = tds[2].innerText;
			el('address').value = tds[3].innerText;
			el('notes').value = tds[4].innerText;
			editingId = id;
			el('formTitle').innerText = 'Sửa hồ sơ';
			el('btnCancelEdit').style.display = 'inline-block';
		}

		// Events
		el('btnSubmit').addEventListener('click', submitForm);
		el('btnCancelEdit').addEventListener('click', resetForm);
		el('btnSearch').addEventListener('click', () => loadRecords(el('searchInput').value.trim()));
		el('btnRefresh').addEventListener('click', () => {
			el('searchInput').value = '';
			loadRecords();
		});
		document.getElementById('recordsTbody').addEventListener('click', (e) => {
			const editId = e.target.getAttribute('data-edit');
			const delId = e.target.getAttribute('data-delete');
			if (editId) startEditRow(editId);
			if (delId) deleteItem(delId);
		});

		// Init
		loadRecords();
	</script>
</body>

</html>